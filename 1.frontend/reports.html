<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Patient Management System</title>

    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    
    <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@400;500;600;700&display=swap" rel="stylesheet">
    
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.1/css/all.min.css">

    <style>
        body {
            font-family: 'Poppins', sans-serif;
            background-color: #f8f9fa;
        }

        /* --- Custom Table Styling to Match Original --- */
        .table-custom thead th {
            background-color: #f8f9fa;
            font-weight: 600;
            border-bottom: 2px solid #dee2e6;
        }
        .table-custom tbody tr:hover {
            background-color: #f1f3f5;
        }
        
        /* --- Sort Icons --- */
        .sort-icon {
            font-size: 0.8rem;
            margin-left: 0.3rem;
            opacity: 0.5;
        }
        .sortable {
            cursor: pointer;
        }
        .sortable.asc .sort-icon, .sortable.desc .sort-icon {
            opacity: 1;
            color: #0d6efd;
        }

        /* --- Visit Accordion --- */
        .visit-header {
            cursor: pointer;
            transition: background-color 0.2s;
        }
        .visit-header:hover {
            background-color: #e9ecef;
        }
        .visit-header .icon i {
            transition: transform 0.3s ease;
        }
        .visit-header.collapsed .icon i {
            transform: rotate(0deg);
        }
        .visit-header:not(.collapsed) .icon i {
            transform: rotate(180deg);
        }

        /* --- Print Styles --- */
        @media print {
            body { background-color: white; }
            .no-print { display: none !important; }
            .modal-content { box-shadow: none; border: none; }
            .modal-header { border-bottom: 2px solid black; }
            .visit-collapse { display: block !important; } /* Expand all for print */
        }
    </style>
</head>
<body class="p-4">

    <div class="container-fluid bg-white rounded shadow-sm p-4 no-print">
        <header class="text-center mb-4">
            <h1 class="text-primary fw-bold">Patient Management System</h1>
            <p class="text-muted">Search, filter, and manage patient records.</p>
        </header>

        <div class="bg-light p-3 rounded mb-4">
            <div class="row g-3">
                <div class="col-md-3">
                    <label for="filter-department" class="form-label fw-medium">Department</label>
                    <select id="filter-department" class="form-select">
                        <option value="">All Departments</option>
                        <option value="Cardiology">Cardiology</option>
                        <option value="Dermatology">Dermatology</option>
                        <option value="General Physician">General Physician</option>
                        <option value="Orthopedics">Orthopedics</option>
                    </select>
                </div>
                <div class="col-md-3">
                    <label for="filter-doctor" class="form-label fw-medium">Doctor</label>
                    <select id="filter-doctor" class="form-select">
                        <option value="">All Doctors</option>
                        <option value="Dr. Sharma">Dr. Sharma</option>
                        <option value="Dr. Gupta">Dr. Gupta</option>
                        <option value="Dr. Reddy">Dr. Reddy</option>
                        <option value="Dr. Singh">Dr. Singh</option>
                    </select>
                </div>
                <div class="col-md-3">
                    <label for="filter-date-start" class="form-label fw-medium">Last Visit From</label>
                    <input type="date" id="filter-date-start" class="form-control">
                </div>
                <div class="col-md-3">
                    <label for="filter-date-end" class="form-label fw-medium">Last Visit To</label>
                    <input type="date" id="filter-date-end" class="form-control">
                </div>
            </div>
            
            <hr class="my-3">

            <div class="d-flex flex-column flex-md-row justify-content-between align-items-center gap-3">
                <input type="text" id="main-search" class="form-control" style="max-width: 400px;" placeholder="Search by Name, ID, Phone, or Diagnosis...">
                <button id="add-patient-btn" class="btn btn-primary"><i class="fas fa-plus me-2"></i>Add New Patient</button>
            </div>
        </div>

        <div class="table-responsive">
            <table class="table table-custom align-middle">
                <thead>
                    <tr>
                        <th>Patient ID</th>
                        <th class="sortable" data-sort="name">Name <span class="sort-icon"><i class="fas fa-sort"></i></span></th>
                        <th>Age</th>
                        <th>Gender</th>
                        <th>Contact</th>
                        <th class="sortable" data-sort="lastVisit">Last Visit <span class="sort-icon"><i class="fas fa-sort"></i></span></th>
                        <th>Diagnosis</th>
                        <th>Actions</th>
                    </tr>
                </thead>
                <tbody id="patient-table-body">
                    </tbody>
            </table>
            <p id="no-table-results" class="text-center text-muted py-5 d-none">No patients found matching your criteria.</p>
        </div>

        <div class="d-flex flex-column flex-md-row justify-content-between align-items-center mt-3">
            <span id="pagination-info" class="text-muted small mb-2 mb-md-0">Showing 0-0 of 0</span>
            <div class="btn-group" id="pagination-controls">
                </div>
        </div>
    </div>

    <div class="modal fade" id="patient-form-modal" tabindex="-1" aria-hidden="true">
        <div class="modal-dialog modal-lg">
            <div class="modal-content">
                <form id="patient-form" novalidate>
                    <div class="modal-header">
                        <h5 class="modal-title fw-bold text-primary" id="form-modal-title">Add New Patient</h5>
                        <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                    </div>
                    <div class="modal-body">
                        <input type="hidden" id="patientId" name="patientId">
                        
                        <h6 class="text-primary border-bottom pb-2 mb-3">Personal Info</h6>
                        <div class="row g-3 mb-4">
                            <div class="col-md-6">
                                <label for="name" class="form-label">Full Name <span class="text-danger">*</span></label>
                                <input type="text" class="form-control" id="name" name="name" required>
                                <div class="invalid-feedback">Name is required.</div>
                            </div>
                            <div class="col-md-6">
                                <label for="dob" class="form-label">Date of Birth <span class="text-danger">*</span></label>
                                <input type="date" class="form-control" id="dob" name="dob" required>
                                <div class="invalid-feedback">Valid date required.</div>
                            </div>
                            <div class="col-md-4">
                                <label for="gender" class="form-label">Gender <span class="text-danger">*</span></label>
                                <select class="form-select" id="gender" name="gender" required>
                                    <option value="">Select...</option>
                                    <option value="Male">Male</option>
                                    <option value="Female">Female</option>
                                    <option value="Other">Other</option>
                                </select>
                                <div class="invalid-feedback">Required.</div>
                            </div>
                            <div class="col-md-4">
                                <label for="phone" class="form-label">Phone <span class="text-danger">*</span></label>
                                <input type="tel" class="form-control" id="phone" name="phone" pattern="[0-9]{10}" required>
                                <div class="invalid-feedback">10-digit number required.</div>
                            </div>
                            <div class="col-md-4">
                                <label for="email" class="form-label">Email</label>
                                <input type="email" class="form-control" id="email" name="email">
                                <div class="invalid-feedback">Invalid email.</div>
                            </div>
                            <div class="col-12">
                                <label for="address" class="form-label">Address</label>
                                <input type="text" class="form-control" id="address" name="address">
                            </div>
                        </div>

                        <h6 class="text-primary border-bottom pb-2 mb-3">Medical History</h6>
                        <div class="row g-3 mb-4">
                            <div class="col-12">
                                <label for="allergies" class="form-label">Allergies (comma-separated)</label>
                                <input type="text" class="form-control" id="allergies" name="allergies">
                            </div>
                            <div class="col-12">
                                <label class="form-label">Chronic Conditions</label>
                                <div class="d-flex gap-3 flex-wrap">
                                    <div class="form-check">
                                        <input class="form-check-input" type="checkbox" name="chronic" value="Diabetes" id="chronic-diabetes">
                                        <label class="form-check-label" for="chronic-diabetes">Diabetes</label>
                                    </div>
                                    <div class="form-check">
                                        <input class="form-check-input" type="checkbox" name="chronic" value="Hypertension" id="chronic-hyper">
                                        <label class="form-check-label" for="chronic-hyper">Hypertension</label>
                                    </div>
                                    <div class="form-check">
                                        <input class="form-check-input" type="checkbox" name="chronic" value="Asthma" id="chronic-asthma">
                                        <label class="form-check-label" for="chronic-asthma">Asthma</label>
                                    </div>
                                    <div class="form-check">
                                        <input class="form-check-input" type="checkbox" name="chronic" value="Arthritis" id="chronic-arthritis">
                                        <label class="form-check-label" for="chronic-arthritis">Arthritis</label>
                                    </div>
                                </div>
                            </div>
                        </div>

                        <div id="visit-details-fieldset">
                            <h6 class="text-primary border-bottom pb-2 mb-3">Latest Visit Details</h6>
                            <div class="row g-3">
                                <div class="col-md-6">
                                    <label for="visitDate" class="form-label">Visit Date <span class="text-danger">*</span></label>
                                    <input type="date" class="form-control" id="visitDate" name="visitDate" required>
                                    <div class="invalid-feedback">Date required.</div>
                                </div>
                                <div class="col-md-6">
                                    <label for="department" class="form-label">Department <span class="text-danger">*</span></label>
                                    <select class="form-select" id="department" name="department" required>
                                        <option value="">Select...</option>
                                        <option value="Cardiology">Cardiology</option>
                                        <option value="Dermatology">Dermatology</option>
                                        <option value="General Physician">General Physician</option>
                                        <option value="Orthopedics">Orthopedics</option>
                                    </select>
                                    <div class="invalid-feedback">Required.</div>
                                </div>
                                <div class="col-md-6">
                                    <label for="doctor" class="form-label">Doctor <span class="text-danger">*</span></label>
                                    <select class="form-select" id="doctor" name="doctor" required>
                                        <option value="">Select...</option>
                                        <option value="Dr. Sharma">Dr. Sharma</option>
                                        <option value="Dr. Gupta">Dr. Gupta</option>
                                        <option value="Dr. Reddy">Dr. Reddy</option>
                                        <option value="Dr. Singh">Dr. Singh</option>
                                    </select>
                                    <div class="invalid-feedback">Required.</div>
                                </div>
                                <div class="col-12">
                                    <label for="diagnosis" class="form-label">Primary Diagnosis <span class="text-danger">*</span></label>
                                    <input type="text" class="form-control" id="diagnosis" name="diagnosis" required>
                                    <div class="invalid-feedback">Diagnosis required.</div>
                                </div>
                            </div>
                        </div>
                    </div>
                    <div class="modal-footer bg-light">
                        <span id="form-error" class="text-danger fw-medium me-3"></span>
                        <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                        <button type="submit" id="save-patient-btn" class="btn btn-primary">Save Patient</button>
                    </div>
                </form>
            </div>
        </div>
    </div>

    <div class="modal fade" id="view-patient-modal" tabindex="-1" aria-hidden="true">
        <div class="modal-dialog modal-lg modal-dialog-scrollable">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title fw-bold">Patient Medical Report</h5>
                    <button type="button" class="btn-close no-print" data-bs-dismiss="modal" aria-label="Close"></button>
                </div>
                <div class="modal-body" id="view-modal-printable-area">
                    <div id="view-patient-details" class="bg-info bg-opacity-10 p-4 rounded border border-info mb-4">
                        </div>

                    <div id="view-visit-records">
                        <h4 class="border-bottom border-primary pb-2 mb-3">Visit History</h4>
                        <div class="accordion" id="view-visits-accordion">
                            </div>
                    </div>

                    <div id="view-audit-log" class="mt-4 pt-3 border-top">
                        <h6 class="text-muted small mb-2">Record History</h6>
                        <ul id="view-audit-log-list" class="list-unstyled text-muted small mb-0"></ul>
                    </div>
                </div>
                <div class="modal-footer no-print">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Close</button>
                    <button type="button" id="print-report-btn" class="btn btn-primary"><i class="fas fa-print me-2"></i>Print Report</button>
                </div>
            </div>
        </div>
    </div>

    <div class="modal fade" id="delete-modal" tabindex="-1" aria-hidden="true">
        <div class="modal-dialog modal-dialog-centered">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title fw-bold">Confirm Deletion</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                </div>
                <div class="modal-body text-center">
                    <p class="mb-1">Are you sure you want to permanently delete this record?</p>
                    <p class="fs-5 fw-bold text-danger" id="delete-patient-name"></p>
                </div>
                <div class="modal-footer bg-light">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                    <button type="button" id="confirm-delete-btn" class="btn btn-danger">Yes, Delete</button>
                </div>
            </div>
        </div>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>

    <script>
    document.addEventListener('DOMContentLoaded', () => {

        // --- MOCK DATABASE ---
        let mockPatientsDB = [
            {
                id: 'PID-001', name: 'Venkatesh P.', dob: '1991-04-15', gender: 'Male', phone: '9876543210', email: 'venkatesh@example.com', address: '123 Main St, Hyderabad', allergies: ['Penicillin'], chronicConditions: ['Hypertension'],
                auditLog: [{ user: 'admin', action: 'Record Created', timestamp: '2025-05-11T10:00:00Z' }],
                visits: [
                    { date: '2025-08-20', doctor: 'Dr. Sharma', department: 'Cardiology', diagnosis: 'Minor Arrhythmia', notes: 'Reported chest pain. ECG minor irregularity.', prescriptions: ['Aspirin 75mg'], labResults: [{ test: 'ECG', result: 'Minor ST-depression' }] },
                    { date: '2025-05-11', doctor: 'Dr. Gupta', department: 'General Physician', diagnosis: 'Annual Check-up', notes: 'BP slightly elevated.', prescriptions: [], labResults: [{ test: 'Lipid Profile', result: 'High Cholesterol' }] }
                ]
            },
            {
                id: 'PID-002', name: 'Priya Sharma', dob: '1997-09-01', gender: 'Female', phone: '9876543211', email: 'priya@example.com', address: '456 Park Ave, Mumbai', allergies: ['Peanuts'], chronicConditions: ['Asthma'],
                auditLog: [{ user: 'admin', action: 'Record Created', timestamp: '2025-09-01T11:00:00Z' }],
                visits: [
                    { date: '2025-09-01', doctor: 'Dr. Reddy', department: 'Dermatology', diagnosis: 'Contact Dermatitis', notes: 'Mild rash on forearm.', prescriptions: ['Hydrocortisone Cream'], labResults: [] }
                ]
            }
        ];

        // --- GLOBAL STATE ---
        const appState = {
            patients: [...mockPatientsDB],
            currentPage: 1,
            rowsPerPage: 5,
            sortColumn: 'name',
            sortDirection: 'asc',
            filters: { search: '', department: '', doctor: '', dateStart: '', dateEnd: '' },
            patientToEdit: null,
            patientToDelete: null
        };

        // --- MODAL INSTANCES ---
        const formModal = new bootstrap.Modal(document.getElementById('patient-form-modal'));
        const viewModal = new bootstrap.Modal(document.getElementById('view-patient-modal'));
        const deleteModal = new bootstrap.Modal(document.getElementById('delete-modal'));

        // --- HELPER FUNCTIONS ---
        const getAge = (dob) => {
            if (!dob) return 'N/A';
            const diff = Date.now() - new Date(dob).getTime();
            return Math.floor(diff / (1000 * 60 * 60 * 24 * 365.25));
        };

        const formatTimestamp = (ts) => new Date(ts).toLocaleString();
        
        const generatePatientId = () => {
            const max = appState.patients.reduce((m, p) => Math.max(m, parseInt(p.id.split('-')[1])), 0);
            return `PID-${String(max + 1).padStart(3, '0')}`;
        };

        // --- DATA PROCESSING ---
        const getProcessedPatients = () => {
            const { search, department, doctor, dateStart, dateEnd } = appState.filters;
            const searchLower = search.toLowerCase();

            let filtered = appState.patients.filter(p => {
                const lastVisit = p.visits[0];
                const visitDate = lastVisit ? new Date(lastVisit.date) : null;
                
                const matchesSearch = !search || p.name.toLowerCase().includes(searchLower) || p.id.toLowerCase().includes(searchLower);
                const matchesDept = !department || (lastVisit && lastVisit.department === department);
                const matchesDoc = !doctor || (lastVisit && lastVisit.doctor === doctor);
                const matchesStart = !dateStart || (visitDate && visitDate >= new Date(dateStart));
                const matchesEnd = !dateEnd || (visitDate && visitDate <= new Date(dateEnd));

                return matchesSearch && matchesDept && matchesDoc && matchesStart && matchesEnd;
            });

            filtered.sort((a, b) => {
                let valA = a[appState.sortColumn]?.toString().toLowerCase() || '';
                let valB = b[appState.sortColumn]?.toString().toLowerCase() || '';
                if(appState.sortColumn === 'lastVisit') {
                    valA = a.visits[0]?.date || '0000-00-00';
                    valB = b.visits[0]?.date || '0000-00-00';
                }
                if(valA < valB) return appState.sortDirection === 'asc' ? -1 : 1;
                if(valA > valB) return appState.sortDirection === 'asc' ? 1 : -1;
                return 0;
            });

            return filtered;
        };

        // --- RENDERING ---
        const renderApp = () => {
            const processed = getProcessedPatients();
            const start = (appState.currentPage - 1) * appState.rowsPerPage;
            const paginated = processed.slice(start, start + appState.rowsPerPage);
            
            // Render Table
            const tbody = document.getElementById('patient-table-body');
            tbody.innerHTML = '';
            
            if (paginated.length === 0) {
                document.getElementById('no-table-results').classList.remove('d-none');
            } else {
                document.getElementById('no-table-results').classList.add('d-none');
                paginated.forEach(p => {
                    const lastVisit = p.visits[0] || {};
                    const tr = document.createElement('tr');
                    tr.innerHTML = `
                        <td class="fw-medium">${p.id}</td>
                        <td>${p.name}</td>
                        <td>${getAge(p.dob)}</td>
                        <td>${p.gender}</td>
                        <td>${p.phone}</td>
                        <td>${lastVisit.date || 'N/A'}</td>
                        <td>${lastVisit.diagnosis || 'N/A'}</td>
                        <td>
                            <button class="btn btn-sm btn-outline-primary me-1 view-btn" data-id="${p.id}"><i class="fas fa-eye"></i></button>
                            <button class="btn btn-sm btn-outline-success me-1 edit-btn" data-id="${p.id}"><i class="fas fa-edit"></i></button>
                            <button class="btn btn-sm btn-outline-danger delete-btn" data-id="${p.id}"><i class="fas fa-trash"></i></button>
                        </td>
                    `;
                    tbody.appendChild(tr);
                });
            }

            // Render Pagination
            const totalPages = Math.ceil(processed.length / appState.rowsPerPage);
            const controls = document.getElementById('pagination-controls');
            controls.innerHTML = '';
            
            document.getElementById('pagination-info').textContent = `Showing ${paginated.length ? start + 1 : 0}-${start + paginated.length} of ${processed.length}`;

            if(totalPages > 1) {
                for(let i = 1; i <= totalPages; i++) {
                    const btn = document.createElement('button');
                    btn.className = `btn btn-outline-secondary btn-sm ${i === appState.currentPage ? 'active' : ''}`;
                    btn.textContent = i;
                    btn.onclick = () => { appState.currentPage = i; renderApp(); };
                    controls.appendChild(btn);
                }
            }

            // Sort Icons
            document.querySelectorAll('.sortable').forEach(th => {
                th.classList.remove('asc', 'desc');
                if(th.dataset.sort === appState.sortColumn) {
                    th.classList.add(appState.sortDirection);
                }
            });
        };

        // --- EVENT LISTENERS ---
        
        // Sorting
        document.querySelectorAll('.sortable').forEach(th => {
            th.addEventListener('click', () => {
                const col = th.dataset.sort;
                if(appState.sortColumn === col) {
                    appState.sortDirection = appState.sortDirection === 'asc' ? 'desc' : 'asc';
                } else {
                    appState.sortColumn = col;
                    appState.sortDirection = 'asc';
                }
                renderApp();
            });
        });

        // Filters
        ['main-search', 'filter-department', 'filter-doctor', 'filter-date-start', 'filter-date-end'].forEach(id => {
            document.getElementById(id).addEventListener('input', (e) => {
                const key = id === 'main-search' ? 'search' : 
                            id === 'filter-department' ? 'department' :
                            id === 'filter-doctor' ? 'doctor' :
                            id === 'filter-date-start' ? 'dateStart' : 'dateEnd';
                appState.filters[key] = e.target.value;
                appState.currentPage = 1;
                renderApp();
            });
        });

        // Actions (Delegation)
        document.getElementById('patient-table-body').addEventListener('click', (e) => {
            const btn = e.target.closest('button');
            if(!btn) return;
            const id = btn.dataset.id;
            
            if(btn.classList.contains('view-btn')) openViewModal(id);
            if(btn.classList.contains('edit-btn')) openEditModal(id);
            if(btn.classList.contains('delete-btn')) openDeleteModal(id);
        });

        // Add Patient
        document.getElementById('add-patient-btn').addEventListener('click', () => {
            appState.patientToEdit = null;
            document.getElementById('patient-form').reset();
            document.getElementById('form-modal-title').textContent = 'Add New Patient';
            document.getElementById('visit-details-fieldset').classList.remove('d-none');
            document.getElementById('patientId').value = generatePatientId();
            document.getElementById('patient-form').classList.remove('was-validated');
            formModal.show();
        });

        // Save Form
        document.getElementById('patient-form').addEventListener('submit', (e) => {
            e.preventDefault();
            const form = e.target;
            
            if (!form.checkValidity()) {
                e.stopPropagation();
                form.classList.add('was-validated');
                return;
            }

            const formData = new FormData(form);
            const entry = {
                id: formData.get('patientId'),
                name: formData.get('name'),
                dob: formData.get('dob'),
                gender: formData.get('gender'),
                phone: formData.get('phone'),
                email: formData.get('email'),
                address: formData.get('address'),
                allergies: formData.get('allergies') ? formData.get('allergies').split(',') : [],
                chronicConditions: Array.from(formData.getAll('chronic')),
                auditLog: [],
                visits: []
            };

            if (appState.patientToEdit) {
                // Update
                const idx = appState.patients.findIndex(p => p.id === entry.id);
                const existing = appState.patients[idx];
                entry.auditLog = [...existing.auditLog, { user: 'admin', action: 'Updated', timestamp: new Date().toISOString() }];
                entry.visits = existing.visits;
                appState.patients[idx] = entry;
            } else {
                // Create
                entry.auditLog = [{ user: 'admin', action: 'Created', timestamp: new Date().toISOString() }];
                entry.visits.push({
                    date: formData.get('visitDate'),
                    department: formData.get('department'),
                    doctor: formData.get('doctor'),
                    diagnosis: formData.get('diagnosis'),
                    notes: '', prescriptions: [], labResults: []
                });
                appState.patients.push(entry);
            }

            formModal.hide();
            renderApp();
        });

        // View Modal Logic
        const openViewModal = (id) => {
            const p = appState.patients.find(x => x.id === id);
            if(!p) return;

            // Details
            document.getElementById('view-patient-details').innerHTML = `
                <h3 class="fw-bold text-dark">${p.name}</h3>
                <div class="row row-cols-1 row-cols-md-2 g-2">
                    <div class="col"><strong>ID:</strong> ${p.id}</div>
                    <div class="col"><strong>Age:</strong> ${getAge(p.dob)}</div>
                    <div class="col"><strong>Phone:</strong> ${p.phone}</div>
                    <div class="col"><strong>Allergies:</strong> ${p.allergies.join(', ') || 'None'}</div>
                </div>
            `;

            // Accordion
            const acc = document.getElementById('view-visits-accordion');
            acc.innerHTML = p.visits.length === 0 ? '<p>No visits.</p>' : 
                p.visits.map((v, i) => `
                    <div class="accordion-item">
                        <h2 class="accordion-header">
                            <button class="accordion-button ${i !== 0 ? 'collapsed' : ''}" type="button" data-bs-toggle="collapse" data-bs-target="#visit-${i}">
                                ${v.date} - ${v.department} (${v.doctor})
                            </button>
                        </h2>
                        <div id="visit-${i}" class="accordion-collapse collapse ${i === 0 ? 'show' : ''} visit-collapse" data-bs-parent="#view-visits-accordion">
                            <div class="accordion-body">
                                <p><strong>Diagnosis:</strong> ${v.diagnosis}</p>
                                <p><strong>Notes:</strong> ${v.notes}</p>
                            </div>
                        </div>
                    </div>
                `).join('');
            
            // Audit Log
            document.getElementById('view-audit-log-list').innerHTML = p.auditLog.map(l => `<li>${formatTimestamp(l.timestamp)}: ${l.action}</li>`).join('');

            viewModal.show();
        };

        // Edit Modal Logic
        const openEditModal = (id) => {
            const p = appState.patients.find(x => x.id === id);
            if(!p) return;
            
            appState.patientToEdit = p;
            const form = document.getElementById('patient-form');
            form.reset();
            form.classList.remove('was-validated');
            
            document.getElementById('form-modal-title').textContent = 'Edit Patient';
            document.getElementById('visit-details-fieldset').classList.add('d-none'); // Hide visit fields for edit
            
            document.getElementById('patientId').value = p.id;
            document.getElementById('name').value = p.name;
            document.getElementById('dob').value = p.dob;
            document.getElementById('gender').value = p.gender;
            document.getElementById('phone').value = p.phone;
            document.getElementById('email').value = p.email || '';
            document.getElementById('address').value = p.address || '';
            document.getElementById('allergies').value = p.allergies.join(',');
            
            // Checkboxes
            document.querySelectorAll('input[name="chronic"]').forEach(cb => {
                cb.checked = p.chronicConditions.includes(cb.value);
            });

            formModal.show();
        };

        // Delete Logic
        const openDeleteModal = (id) => {
            const p = appState.patients.find(x => x.id === id);
            if(!p) return;
            appState.patientToDelete = p;
            document.getElementById('delete-patient-name').textContent = `${p.name} (${p.id})`;
            deleteModal.show();
        };

        document.getElementById('confirm-delete-btn').addEventListener('click', () => {
            if(appState.patientToDelete) {
                appState.patients = appState.patients.filter(p => p.id !== appState.patientToDelete.id);
                appState.patientToDelete = null;
                deleteModal.hide();
                renderApp();
            }
        });

        // Print
        document.getElementById('print-report-btn').addEventListener('click', () => window.print());

        // Init
        renderApp();
    });
    </script>
</body>
</html>